<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ld.gg.dao.Summoner_dao">

	<select id="getRankLoadingData" resultType="summoner_rank">
		SELECT DISTINCT
		sr.summoner_name as summoner_name,
		si.profile_icon_id as
		profile_icon_id, si.s_level as s_level, LOWER(sr.tier) as
		tier,
		sr.division as division,
		sr.wins as wins, sr.losses as losses, sr.lp as
		lp,
		round((sr.wins/(si.games))*100,2) as
		winrate
		FROM summoner_rank sr
		INNER
		JOIN summoner_info si ON sr.summoner_name = si.summoner_name
		WHERE
		sr.queue = 'RANKED_SOLO_5x5' AND LOWER(sr.tier) IN ('challenger',
		'grandmaster', 'master')
		ORDER BY sr.lp DESC;
	</select>

	<select id="getRankSoloData" resultType="summoner_rank">
		SELECT sr.summoner_name,
		si.profile_icon_id, si.s_level, LOWER(sr.tier) as tier, sr.division,
		sr.wins, sr.losses, sr.lp, round((sr.wins/(si.games))*100,2) as
		winrate
		FROM summoner_rank sr
		INNER JOIN summoner_info si ON
		sr.summoner_name = si.summoner_name
		WHERE sr.queue = 'RANKED_SOLO_5x5'
		AND LOWER(sr.tier) IN ('challenger',
		'grandmaster', 'master')
		ORDER BY
		sr.lp DESC;
	</select>

	<select id="getRankFlexData" resultType="summoner_rank">
		SELECT sr.summoner_name,
		si.profile_icon_id, si.s_level, LOWER(sr.tier) as tier, sr.division,
		sr.wins, sr.losses, sr.lp, round((sr.wins/(si.games))*100,2) as
		winrate
		FROM summoner_rank sr
		INNER JOIN summoner_info si ON
		sr.summoner_name = si.summoner_name
		WHERE sr.queue = 'RANKED_FLEX_5x5'
		AND LOWER(sr.tier) IN ('challenger',
		'grandmaster', 'master')
		ORDER BY
		sr.lp DESC;
	</select>

	<select id="getRankLevelData" resultType="summoner">
		SELECT
		sr.summoner_name,
		si.profile_icon_id, si.s_level, LOWER(sr.tier) as
		tier, sr.division,
		sr.wins, sr.losses, sr.lp,
		round((sr.wins/(si.games))*100,2) as
		winrate
		FROM summoner_rank sr
		INNER
		JOIN summoner_info si ON
		sr.summoner_name = si.summoner_name
		WHERE
		sr.queue = 'RANKED_SOLO_5x5'
		ORDER BY
		si.s_level DESC;
	</select>

	<select id="get_summoner_info" resultType="summoner">
		SELECT DISTINCT
		summoner_name, s_level, profile_icon_id, games, LOWER(tier)
		as tier,
		wins, losses, lp, ranking, MIN(revision_date) as
		revision_date,
		tier_int
		FROM summoner_info
		WHERE summoner_name = #{summoner_name}
		GROUP
		BY summoner_name, s_level, profile_icon_id, games, LOWER(tier), wins,
		losses, lp, ranking, tier_int;
	</select>

	<select id="get_renewal_info" resultType="summoner">
		SELECT * FROM
		SUMMONER_INFO
		WHERE summoner_name = ${summoner_name}
	</select>

	<select id="get_summoner_record" resultType="record">
		SELECT
		match_id,
		win,
		champ_name,
		champ_level,
		team_id,
		main_rune,
		sub_rune,
		spell1,
		spell2,
		kda,
		kills,
		deaths,
		assists,
		cs,
		sight_points,
		red_wards_placed,
		ROUND(team_champion_kills / kills, 2) AS kill_involve,
		item1,
		item2,
		item3,
		item4,
		item5,
		item6,
		item7,
		t.summoner_name,
		t.champion_name AS
		player_champion_name,
		team_id,
		team_champion_kills
		FROM
		RECORD
		JOIN
		(SELECT
		summoner_name,
		champion_name
		FROM
		RECORD
		WHERE
		summoner_name =
		#{summoner_name}) AS t
		ON
		RECORD.match_id = t.match_id;
	</select>

	<select id="get_champ_record" resultType="champ_record">
		SELECT
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 1) AS
		wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 0) AS
		losses,
		champ_name,
		COUNT(*) AS games,
		(SUM(CASE WHEN win = 1 THEN 1 ELSE 0 END) / COUNT(*)) * 100 AS winrate,
		(SUM(kills) + SUM(assists)) / SUM(deaths) AS KDA,
		SUM(kills) AS kills,
		SUM(deaths) AS deaths,
		SUM(assists) AS assists,
		SUM(CS) AS CS,
		ROUND(SUM(CS) / COUNT(*), 2) AS CS_per_minute
		FROM
		record
		WHERE
		summoner_name = #{summoner_name}
		GROUP BY
		champ_name;
	</select>

	<select id="getChampSolo">
		SELECT
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 1) AS
		wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 0) AS
		losses,
		champ_name,
		COUNT(*) AS games,
		(SUM(CASE WHEN win = 1 THEN 1 ELSE 0 END) / COUNT(*)) * 100 AS winrate,
		(SUM(kills) + SUM(assists)) / SUM(deaths) AS KDA,
		SUM(kills) AS kills,
		SUM(deaths) AS deaths,
		SUM(assists) AS assists,
		SUM(CS) AS CS,
		ROUND(SUM(CS) / COUNT(*), 2) AS CS_per_minute
		FROM
		record
		WHERE
		summoner_name = #{summoner_name}
		GROUP BY
		champ_name;
	</select>

	<select id="getChampFlex">
		SELECT
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 1) AS
		wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 0) AS
		losses,
		champ_name,
		COUNT(*) AS games,
		(SUM(CASE WHEN win = 1 THEN 1 ELSE 0 END) / COUNT(*)) * 100 AS winrate,
		(SUM(kills) + SUM(assists)) / SUM(deaths) AS KDA,
		SUM(kills) AS kills,
		SUM(deaths) AS deaths,
		SUM(assists) AS assists,
		SUM(CS) AS CS,
		ROUND(SUM(CS) / COUNT(*), 2) AS CS_per_minute
		FROM
		record
		WHERE
		summoner_name = #{summoner_name}
		GROUP BY
		champ_name;
	</select>

	<select id="getChampClassic">
		SELECT
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 1) AS
		wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name} AND win = 0) AS
		losses,
		champ_name,
		COUNT(*) AS games,
		(SUM(CASE WHEN win = 1 THEN 1 ELSE 0 END) / COUNT(*)) * 100 AS winrate,
		(SUM(kills) + SUM(assists)) / SUM(deaths) AS KDA,
		SUM(kills) AS kills,
		SUM(deaths) AS deaths,
		SUM(assists) AS assists,
		SUM(CS) AS CS,
		ROUND(SUM(CS) / COUNT(*), 2) AS CS_per_minute
		FROM
		record
		WHERE
		summoner_name = #{summoner_name}
		GROUP BY
		champ_name;
	</select>

	<select id="get_20games_summary" resultType = "recordsummary">
		SELECT
  		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND win = 1) AS wins,
  		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND win = 0) AS losses,
  		ROUND((SUM(CASE WHEN win = 1 THEN 1 ELSE 0 END) / COUNT(*)) * 100, 2) AS winrate,
  		ROUND(SUM(kills) / COUNT(*), 1) AS kills_avg,
		ROUND(SUM(deaths) / COUNT(*), 1) AS deaths_avg,
		ROUND(SUM(assists) / COUNT(*), 1) AS assists_avg,
		ROUND(SUM(kda) / COUNT(*), 2) AS kda_avg,
		MAX(kda) AS max_kda,
		(SELECT kills FROM record WHERE summoner_name = '#{summoner_name}' ORDER BY kda DESC LIMIT 1) AS max_kills,
		(SELECT deaths FROM record WHERE summoner_name = '#{summoner_name}' ORDER BY kda DESC LIMIT 1) AS max_deaths,
		(SELECT assists FROM record WHERE summoner_name = '#{summoner_name}' ORDER BY kda DESC LIMIT 1) AS max_assists,
		(SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1) AS top_champ1,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1) AND win = 1) AS top_champ1_wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1) AND win = 0) AS top_champ1_losses,
		ROUND((SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1) AND win = 1) / (SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1)) * 100, 2) AS top_champ1_winrate,
		ROUND(SUM(CASE WHEN champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1) AS subquery1) THEN kda ELSE 0 END) / COUNT(*), 2) AS top_champ1_kda_avg,
		(SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2) AS top_champ2,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2) AND win = 1) AS top_champ2_wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2) AND win = 0) AS top_champ2_losses,
		ROUND((SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2) AND win = 1) / (SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2)) * 100, 2) AS top_champ2_winrate,
		ROUND(SUM(CASE WHEN champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 1, 1) AS subquery2) THEN kda ELSE 0 END) / COUNT(*), 2) AS top_champ2_kda_avg,
		(SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3) AS top_champ3,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3) AND win = 1) AS top_champ3_wins,
		(SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3) AND win = 0) AS top_champ3_losses,
		ROUND((SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3) AND win = 1) / (SELECT COUNT(*) FROM record WHERE summoner_name = '#{summoner_name}' AND champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3)) * 100, 2) AS top_champ3_winrate,
		ROUND(SUM(CASE WHEN champ_name = (SELECT champ_name FROM (SELECT champ_name, COUNT(*) AS champ_count FROM record WHERE summoner_name = '#{summoner_name}' GROUP BY champ_name ORDER BY champ_count DESC LIMIT 2, 1) AS subquery3) THEN kda ELSE 0 END) / COUNT(*), 2) AS top_champ3_kda_avg
		FROM record
		WHERE summoner_name = '#{summoner_name}';
	</select>

	<select id="get_champ_position_filter"
		resultMap="positionPickRateMap">
		SELECT lane, COUNT(*) / (SELECT COUNT(*) FROM record WHERE summoner_name = #{summoner_name}) * 100 AS pick_rate
		FROM record
		WHERE summoner_name = #{summoner_name}
		GROUP BY lane
		ORDER BY COUNT(*) DESC
		LIMIT 3;
	</select>

	<resultMap id="positionPickRateMap" type="champ_record">
		<result property="lane" column="lane" />
		<result property="pick_rate" column="pick_rate" />
	</resultMap>

<select id="get_record_detail" resultType="record">
SELECT
  r.summoner_name AS summoner_name,
  r.win as win,
  r.team_tower_kills AS team_tower_kills,
  r.team_dragon_kills AS team_dragon_kills,
  r.team_baron_kills AS team_baron_kills,
  r.team_id AS team_id,
  r.team_champion_kills AS team_champion_kills,
  r.team_champion_deaths AS team_champion_deaths,
  (SELECT SUM(assists) FROM record WHERE match_id = #{match_id} AND team_id = r.team_id) AS team_champion_assists,
  r.champ_name AS champ_name,
  r.champ_level AS champ_level,
  r.spell1 AS spell1,
  r.spell2 AS spell2,
  r.main_rune AS main_rune,
  r.main_rune1 AS main_rune1,
  r.sub_rune AS sub_rune,
  r.kills AS kills,
  r.deaths AS deaths,
  r.assists AS assists,
  r.kda AS kda,
  r.cs AS cs,
  r.red_ward_placed AS red_ward_placed,
  r.dealt_to_champ AS dealt_to_champ,
  r.item1 AS item1,
  r.item2 AS item2,
  r.item3 AS item3,
  r.item4 AS item4,
  r.item5 AS item5,
  r.item6 AS item6,
  r.item7 AS item7,
  LOWER(si.tier) AS tier
FROM
  record r
  JOIN summoner_info si ON r.summoner_name = si.summoner_name
  JOIN record s ON r.team_id = s.team_id
WHERE
  r.match_id = '#{match_id}
GROUP BY
  r.summoner_name,
  r.win,
  r.team_tower_kills,
  r.team_dragon_kills,
  r.team_baron_kills,
  r.team_id,
  r.team_champion_kills,
  r.team_champion_deaths,
  r.champ_name,
  r.champ_level,
  r.spell1,
  r.spell2,
  r.main_rune,
  r.main_rune1,
  r.sub_rune,
  r.kills,
  r.deaths,
  r.assists,
  r.kda,
  r.cs,
  r.red_ward_placed,
  r.dealt_to_champ,
  r.item1,
  r.item2,
  r.item3,
  r.item4,
  r.item5,
  r.item6,
  r.item7,
  si.tier;
</select>

<select id="getBuild" resultType="build">
	SELECT
	t.mini_t_time AS
	timestamp,
	t.item_id,
	t.mini_t_skill_slot,
	r.main_rune,
	r.main_rune1,
	r.main_rune2,
	r.main_rune3,
	r.main_rune4,
	r.sub_rune,
	r.sub_rune1,
	r.sub_rune2,
	r.rune_stat1,
	r.rune_stat2,
	r.rune_stat3
	FROM
	time_line_data t
	LEFT JOIN
	record r ON t.match_id = r.match_id AND t.summoner_name =
	r.summoner_name
	WHERE
	t.match_id = #{matchId}
	AND t.summoner_name =
	#{summonerName}
</select>

	<!-- <select id="getRanking" resultType="recordRanking"> SELECT '본인' AS 
		player_type, self_dealt AS dealt, self_taken AS taken, self_kills AS kills, 
		self_deaths AS deaths, self_assists AS assists, self_red_wards AS red_wards, 
		self_cs AS cs FROM record WHERE match_id = #{matchId} AND summoner_name = 
		#{summonerName} UNION SELECT '팀원' AS player_type, team_dealt1 AS dealt, team_taken1 
		AS taken, team_kills1 AS kills, team_deaths1 AS deaths, team_assists1 AS 
		assists, team_red_wards1 AS red_wards, team_cs1 AS cs FROM record WHERE match_id 
		= #{matchId} AND summoner_name <> #{summonerName} AND team_id = ( SELECT 
		team_id FROM record WHERE match_id = #{matchId} AND summoner_name = #{summonerName} 
		) UNION SELECT '팀원' AS player_type, team_dealt2 AS dealt, team_taken2 AS 
		taken, team_kills2 AS kills, team_deaths2 AS deaths, team_assists2 AS assists, 
		team_red_wards2 AS red_wards, team_cs2 AS cs FROM record WHERE match_id = 
		#{matchId} AND summoner_name <> #{summonerName} AND team_id = ( SELECT team_id 
		FROM record WHERE match_id = #{matchId} AND summoner_name = #{summonerName} 
		) UNION SELECT '팀원' AS player_type, team_dealt3 AS dealt, team_taken3 AS 
		taken, team_kills3 AS kills, team_deaths3 AS deaths, team_assists3 AS assists, 
		team_red_wards3 AS red_wards, team_cs3 AS cs FROM record WHERE match_id = 
		#{matchId} AND summoner_name <> #{summonerName} AND team_id = ( SELECT team_id 
		FROM record WHERE match_id = #{matchId} AND summoner_name = #{summonerName} 
		) UNION SELECT '팀원' AS player_type, team_dealt4 AS dealt, team_taken4 AS 
		taken, team_kills4 AS kills, team_deaths4 AS deaths, team_assists4 AS assists, 
		team_red_wards4 AS red_wards, team_cs4 AS cs FROM record WHERE match_id = 
		#{matchId} AND summoner_name <> #{summonerName} AND team_id = ( SELECT team_id 
		FROM record WHERE match_id = #{matchId} AND summoner_name = #{summonerName} 
		); </select> -->

	<select id="getSummoner" resultType="summoner">
		select summoner_name,
		LOWER(tier) as tier,
		profile_icon_id,
		games,
		wins,
		losses,
		lp,
		round((wins /
		games) * 100,2) as winrate
		from summoner_info
		where summoner_name =
		"8찬이하밥상엎음"
	</select>

	<!-- <select id="getDashBoardKDA" resultType="dashboard"> SELECT COUNT(CASE 
		WHEN win = 1 THEN 1 END) AS wins, COUNT(CASE WHEN win = 0 THEN 1 END) AS 
		losses, SUM(kills) / 20 AS kills_avg, SUM(deaths) / 20 AS deaths_avg, SUM(assists) 
		/ 20 AS assists_avg, SUM(kda) / 20 AS kda_avg FROM record WHERE summoner_name 
		= #{summoner_name} LIMIT 20; </select> -->

</mapper>